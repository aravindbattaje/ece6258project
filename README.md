# Ping pong ball tracker (offline)

This is part of the project for ECE-6258 (Digital image processing) at Georgia Tech.

**Important note**: To have all elements displayed properly (for example images), please read this `README.md` file with a markdown renderer or as an easier alternative, on Github where this is hosted (https://github.com/aravindbattaje/ece6258project/blob/master/README.md).

## Prerequisites

- Python 2.7.x
- OpenCV 3.3.0
- Numpy 1.13+
- Matplotlib 1.5+

## Main scripts to use
- `calib_save_images.py`
- `calib_find_intrinsics_images.py`
- `calib_find_extrinsics_images.py`

## File description and usage

### General usage

Get the usage instructions for a particular Python script `<python_file>.py` by typing the following in command line:

`python <python_file>.py -h`.

Also, generally use `q` key on the GUI to stop execution.

### Prepare for camera calibration

The camera intrinsic properties are found using a special calibration board. The calibration board can be generated by running

`python calib_generate_charuco.py`

This generates a calibration board in the root folder called `calib_charuco_board.png` like below image.

![calibration_board](calib_charuco_board.png)

The parameters of the calibration board can be changed by editing the script.

### Find intrinsic parameters of camera

After the above generated calibration board is printed to 100% scale, and carefully displayed in various views in front of the camera, and recording the corresponding video, the following scripts can be used to find the intrinsic parameters a camera.

#### From images

First, manually select (at least 25) candidate images from the calibration video by running

`python calib_save_images.py --video <path_to_video_file>`

This opens a GUI showing the first frame of the video file. Click on playback slider to start playing video and click on it again to pause. Use the following keyboard shortcuts:

- `s` - Save current image
- `b` - Seek back 1 second
- `n` - Go ahead 1 second

The images will be stored in the folder `calib_images`. Example saved image:

![example_calib_image](calib_images/two_1_gopr0010_6281.png)

These cherry-picked images will be used as input to the script that finds calibration parameters

`python calib_find_intrinsics_images.py --video <path_to_video_file> --model <P/F>`

The `--model/-m` argument specifies the camera projection model to use. The input can be either `P` for pinhole camera or `F` for fisheye model.

This script produces a file (`new_calib_<camera_model>.npz`) with the found calibration parameters. It also outputs the RMS error on terminal. Generally a _good_ calibration will have an RMS error less than 10. Also, the markers in the calibration board for each image are found and saved back in to the `calib_images` folder for inspection. Example:

![example_calib_image_markers](calib_images/two_1_gopr0010_6281_markers.png)

#### Directly from video

**Note: Deprecated.** Don't use this now. The script is retained to easily update in the future (for example, online implementation).

`python calib_find_intrinsics_video.py --video <path_to_video_file>`

The intrinsic calibration will be written to the file `new_calib.npz` in the root directory.

## Find extrinsic parameters of camera

## Utils

## Notes

Ensure `opencv_ffmpeg*.dll` file is present in the current directory or in `PATH`. This is required for reading video.

Generally quitting (with `q`) on `get_*.py` will save important parameters to `new_*.pickle` in root folder. Copy over the _good_ parameters to config folder.

Generally the GUIs are not updated with seek positions. That is, when video moves forward, the seek bar is not updated, but the other way works -- when seek bar is moved, video position changes.

Convert all video inputs to 30 fps or 60 fps to work across all platforms. There were video decoder problems with 80 fps videos on Windows.

Don't use `calib_find_instrinsics_video.py`. It is old, and uses frames from video without much intelligence. Use `calib_find_intrinsics_images.py` with manually selected images instead for reliability.

Keyboard shortcuts for `calib_find_intrinsics_images.py`:

- `s` - save current image
- `b` - seek back 1s
- `n` - go ahead 1s

`calib_find_intrinsics_images.py` expects the folder `calib_images` to be present in the root directory. It also accepts the normal `--video` argument that other scripts expect as video file name is used as prefix for finding calibration images. If calibration video not available, fool this script with a dummy video (file name).

Tested on **GoPro Hero3+ Silver** and **GoPro Hero5 Black**.

Mayavi, VTK, VCPython27, PyQt4